# VINE Format Specification — Version 1.0.0

## Overview

A `.vine` file is a plain-text, line-oriented format for describing a directed acyclic task graph. It is designed to be hand-authored, formally grammar-defined, trivially parseable, and diffable in version control.

Every `.vine` file begins with a **magic line** declaring its format version. A conforming parser reads only the first line before deciding which version-specific rules to apply. If the first line does not match `vine <version>`, the file is **invalid**.

## File Structure

A `.vine` file has three regions:

1. **Preamble** — magic line + optional metadata, terminated by the default delimiter (`---`)
2. **Task blocks** — one or more, separated by the delimiter
3. **Root convention** — the **first** task block is the root of the graph

```
vine 1.0.0                    ← magic line
title: My Project Plan        ← metadata (optional)
delimiter: ===                ← metadata (optional)
---                           ← preamble terminator (always ---)
[root] Root Task (started)    ← first task = root
...
===                           ← task separator (custom delimiter)
[child] Child Task (planning)
...
```

## Preamble

### Magic Line

The first line of every `.vine` file **must** be:

```
vine <version>
```

where `<version>` is a [SemVer](https://semver.org/) string. For this specification: `vine 1.0.0`.

A parser reads this line to determine which version-specific rules to apply. Files without a valid magic line are rejected.

### Metadata

Lines between the magic line and the first `---` are **metadata**, specified as `key: value` pairs (one per line). Leading and trailing whitespace on both key and value is trimmed.

**Defined keys for v1.0.0:**

| Key         | Required | Default | Description                                          |
| ----------- | -------- | ------- | ---------------------------------------------------- |
| `title`     | no       | —       | Human-readable name for the graph.                   |
| `delimiter` | no       | `---`   | String used on its own line to separate task blocks. |

Unknown keys are preserved but ignored by conforming parsers. This allows forward-compatible extension without a version bump for non-structural metadata.

### Preamble Terminator

The preamble is **always** terminated by a line containing exactly `---` (three hyphens, no leading or trailing whitespace). This is true even when a custom `delimiter` is specified — the preamble terminator is fixed to avoid a bootstrap problem (the parser must finish reading metadata before it knows the delimiter).

After the preamble terminator, all subsequent block boundaries use the configured delimiter.

## Delimiter

The delimiter is a line containing **exactly** the delimiter string — no leading or trailing whitespace. It separates consecutive task blocks and marks the boundary between the preamble and the first task.

- **Default**: `---` (three hyphens)
- **Custom**: set via the `delimiter` metadata key

Because the delimiter is a standalone separator line, description text within a task block may contain blank lines without ambiguity.

## Task Block

Each task block consists of:

1. **Header line** (required, exactly one) — the first line of the block
2. **Body lines** (optional, zero or more) — all subsequent lines until the next delimiter or end of file

### Header Line

```
[id] Short Name (status)
```

| Component    | Rules                                                                                       |
| ------------ | ------------------------------------------------------------------------------------------- |
| `id`         | Enclosed in `[ ]`. Alphanumeric and hyphens only (`[a-zA-Z0-9-]+`). Unique within the file. |
| `Short Name` | Free text between `]` and `(`. Leading/trailing whitespace trimmed.                         |
| `status`     | Enclosed in `( )` at end of line. One of the status keywords below.                         |

**Header regex:**

```
^\[([a-zA-Z0-9-]+)\]\s+(.+?)\s+\((complete|started|reviewing|planning|notstarted|blocked)\)$
```

### Status Keywords

| Keyword      | Meaning                                               |
| ------------ | ----------------------------------------------------- |
| `complete`   | Finished — 100% done.                                 |
| `started`    | Implementation in progress, not yet complete.         |
| `reviewing`  | Work believed complete, pending review by dependants. |
| `planning`   | Planning started but not yet complete.                |
| `notstarted` | Planning complete, work not yet begun.                |
| `blocked`    | Needs intervention to resume.                         |

### Body Lines

Body lines follow the header and are classified by prefix. The parser checks prefixes in priority order — the **first match wins**:

| Priority | Prefix       | Meaning         | Example                                               |
| -------- | ------------ | --------------- | ----------------------------------------------------- |
| 1        | `-> `        | **Dependency**  | `-> setup-db`                                         |
| 2        | `> `         | **Decision**    | `> Use PostgreSQL over SQLite`                        |
| 3        | `@artifact ` | **Artifact**    | `@artifact application/pdf https://example.com/r.pdf` |
| 4        | `@guidance ` | **Guidance**    | `@guidance text/markdown https://example.com/g.md`    |
| 5        | `@file `     | **File**        | `@file image/png https://example.com/sketch.png`      |
| 6        | _(none)_     | **Description** | `Build the authentication flow.`                      |

Body lines may appear in **any order**. The serializer normalizes to a canonical order (see [Serialization](#serialization)).

**Description lines** preserve newlines. Multiple description lines are joined with `\n` (not space). Blank lines within a task block (between the header and the next delimiter) are preserved as empty description lines.

## Attachments

Attachments associate external resources with a task. Each attachment line specifies a **class**, a **MIME type**, and a **URI**:

```
@<class> <mime-type> <uri>
```

| Class      | Semantics                                                                                             |
| ---------- | ----------------------------------------------------------------------------------------------------- |
| `artifact` | Product of work. A reviewer examines artifacts to judge whether the task was completed.               |
| `guidance` | Context or constraints on the work. Available during review to verify work respected its limitations. |
| `file`     | Any other attached resource. Carries no semantic classification beyond what the MIME type conveys.    |

- MIME types follow [RFC 6838](https://datatracker.ietf.org/doc/html/rfc6838).
- URIs follow [RFC 3986](https://datatracker.ietf.org/doc/html/rfc3986). Relative URIs are resolved against the `.vine` file's location.
- Multiple attachments per task are allowed.
- Lines starting with `@` followed by an unrecognized class are treated as description text.

## Ordering

The **first task** in the file is the root. Subsequent tasks follow a top-down order — dependants appear before their dependencies, drilling down toward leaves.

Ordering is **mandatory** and carries semantic meaning: it represents the suggested reading and tackling order. The dependency graph remains the source of truth for parallelism and sequencing.

## Constraints

A valid `.vine` file must satisfy all of the following:

1. **At least one task** — the file must contain one or more task blocks.
2. **Unique IDs** — no two tasks may share the same `id`.
3. **Valid dependency refs** — every `-> <id>` must reference a task `id` defined in the same file.
4. **No cycles** — the dependency graph must be a DAG.
5. **No islands** — every task must be reachable from the root (first task) by traversing dependency edges.

## ABNF Grammar

The following grammar is defined per [RFC 5234](https://datatracker.ietf.org/doc/html/rfc5234). It describes the **syntactic** structure of a `.vine` file. Structural constraints (uniqueness, cycle-freedom, connectivity) are enforced after parsing.

```abnf
vine-file      = preamble default-delim *WSP LF
                 task-block *(delim task-block)
                 [delim]                        ; optional trailing delimiter

preamble       = magic-line *metadata-line

magic-line     = %s"vine" SP version LF

version        = 1*DIGIT "." 1*DIGIT "." 1*DIGIT

metadata-line  = meta-key ":" *WSP meta-value LF

meta-key       = 1*(ALPHA / DIGIT / "-" / "_")

meta-value     = *(%x20-7E)                    ; printable ASCII

default-delim  = %s"---" LF                    ; always three hyphens

delim          = delim-string LF               ; configured delimiter

delim-string   = *(%x20-7E)                    ; defined by metadata or "---"

task-block     = header-line LF *body-line

header-line    = "[" task-id "]" 1*WSP short-name 1*WSP "(" status ")"

task-id        = 1*(ALPHA / DIGIT / "-")

short-name     = 1*(%x20-7E)                   ; free text, trimmed

status         = %s"complete" / %s"started" / %s"reviewing"
               / %s"planning" / %s"notstarted" / %s"blocked"

body-line      = dependency / decision / attachment / description-line

dependency     = %s"->" SP dep-target LF

dep-target     = task-id

decision       = ">" SP decision-text LF

decision-text  = *(%x20-7E)

attachment     = "@" att-class SP mime-type SP uri LF

att-class      = %s"artifact" / %s"guidance" / %s"file"

mime-type      = type "/" subtype
type           = 1*(ALPHA / DIGIT / "-")
subtype        = 1*(ALPHA / DIGIT / "-" / ".")

uri            = 1*(%x21-7E)                   ; non-whitespace printable ASCII

description-line = *(%x20-7E) LF               ; any line not matching above
```

> **Note on `description-line`**: In the grammar above, `description-line` overlaps with other `body-line` alternatives syntactically. In practice, parsing uses **prefix-priority dispatch**: a line is tested against dependency, decision, and attachment prefixes in order. Only if none match is the line treated as description. The ABNF captures the character-level syntax; the prefix-priority rule is a semantic constraint on the parser.

## Parsing Algorithm

```
1. Read the first line.
   - It must match "vine <version>". Extract the version.
   - If it does not match, reject the file.

2. Dispatch to the parser for the extracted version.
   For version 1.0.0:

3. Read lines until a line containing exactly "---".
   - Parse each line as "key: value" metadata.
   - If a "delimiter" key is present, record its value as DELIM.
   - Otherwise, DELIM = "---".

4. Split the remainder of the file on lines matching DELIM exactly.
   - Each segment is a raw task block.
   - Empty trailing segments (from a trailing delimiter) are discarded.

5. For each raw task block:
   a. The first non-empty line is the header.
      Extract id, short name, and status via the header regex.
   b. Classify each subsequent line by prefix (priority order):
      - Starts with "-> "       → dependency (value = rest of line, trimmed)
      - Starts with "> "        → decision  (value = rest of line, trimmed)
      - Starts with "@artifact " → artifact  (parse mime + uri)
      - Starts with "@guidance " → guidance  (parse mime + uri)
      - Starts with "@file "     → file      (parse mime + uri)
      - Otherwise               → description line (preserved verbatim)
   c. Join description lines with "\n".

6. Build the task graph and validate constraints.
```

## Serialization

The **canonical form** is used for roundtripping and diffing:

1. **Magic line**: `vine 1.0.0`
2. **Metadata**: defined keys in alphabetical order, one per line
3. **Preamble terminator**: `---`
4. **Task blocks** in file order (root first), separated by the delimiter
5. **Body line order** within each block:
   - Description lines (preserving internal newlines)
   - Dependencies (`-> ...`), sorted alphabetically by target id
   - Decisions (`> ...`), in original order
   - Attachments, grouped by class (`@artifact`, `@guidance`, `@file`), each group in original order
6. **Trailing newline** after the final task block (no trailing delimiter)

## Examples

### Minimal

```vine
vine 1.0.0
---
[root] My Single Task (notstarted)
The simplest possible graph.
```

### Full-Featured

```vine
vine 1.0.0
title: Project Bacchus
---
[root] Project Bacchus (started)
Build a graph of tasks and visualize them as a vine.
-> vine-format
-> vine-ts
-> build-ui
-> graph-cli
---
[graph-cli] Graph Interface (planning)
CLI for pulling, creating, and updating work.
-> vine-ts
-> build-ui
---
[build-ui] Build Graph Visualizer (reviewing)
Render the task graph with d3-force.

This task has a multi-line description. The blank line
above is preserved as part of the description text.
-> vine-ts
@artifact text/html https://example.com/ui-demo/index.html
@guidance text/markdown https://example.com/ui-style-guide.md
---
[vine-ts] VINE TypeScript Library (started)
Parse and validate .vine files.
-> vine-format
@artifact application/zip https://example.com/vine-ts-0.1.0.tgz
---
[vine-format] Define VINE Format (complete)
Specify the .vine file format.
> Keep it line-oriented, no nesting.
> Version the format with a magic line.
@file application/pdf https://example.com/vine-spec-draft.pdf
```
